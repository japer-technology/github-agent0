# Workflow Design Theory

## Overview

This repository defines two GitHub Actions workflows that together form the **Issue Intelligence** system ‚Äî an AI agent that operates entirely through GitHub Issues and Actions. This document analyzes the design theory, effects, and architectural implications of each workflow.

---

## Workflows Defined

### 1. `ISSUE-INTELLIGENCE-WORKFLOW-AGENT.yml` ‚Äî The Agent Workflow

**Location:** `.github/workflows/ISSUE-INTELLIGENCE-WORKFLOW-AGENT.yml`

**Trigger events:**
- `issues` ‚Üí `opened` ‚Äî fires when a new issue is created
- `issue_comment` ‚Üí `created` ‚Äî fires when a comment is posted on any issue

**Permissions granted:**
- `contents: write` ‚Äî allows the workflow to commit and push changes to the repository
- `issues: write` ‚Äî allows the workflow to post comments and manage reactions on issues
- `actions: write` ‚Äî allows the workflow to interact with the Actions API

#### Effect

This workflow transforms every GitHub issue into a conversational AI session. When a user opens an issue or comments on one, the workflow orchestrates a multi-step pipeline that processes the input through an AI coding agent and responds directly on the issue thread.

**Step-by-step effects:**

| Step | Name | Effect |
|------|------|--------|
| 1 | **Authorize** | Queries the GitHub API to verify the triggering actor has `write`, `maintain`, or `admin` permission on the repository. Unauthorized users are rejected immediately ‚Äî this prevents arbitrary public users from consuming AI API credits or triggering agent actions on public repos. |
| 2 | **Checkout** | Clones the repository at the default branch with full history (`fetch-depth: 0`). The full history is required because the agent can read and write files, and the push-retry logic uses `git rebase`. |
| 3 | **Setup Bun** | Installs the Bun JavaScript runtime. Bun is used as the script executor and package manager for all lifecycle TypeScript files. |
| 4 | **Guard** | Runs `ISSUE-INTELLIGENCE-ENABLED.ts` ‚Äî a fail-closed sentinel check. If `.issue-intelligence/ISSUE-INTELLIGENCE-ENABLED.md` does not exist, the entire workflow halts. This ensures the agent is always opt-in and can be instantly disabled by deleting a single file. An optional secondary gate (`ISSUE-INTELLIGENCE-HEART-REQUIRED.md`) requires a ‚ù§Ô∏è reaction on new issues before the agent will process them. |
| 5 | **Preinstall** | Runs `ISSUE-INTELLIGENCE-INDICATOR.ts` ‚Äî adds a üëÄ reaction to the triggering issue or comment as a visual activity indicator. Persists reaction metadata to `/tmp/reaction-state.json` for cleanup later. This runs before dependency installation to provide immediate user feedback. |
| 6 | **Install dependencies** | Runs `bun install --frozen-lockfile` inside the `.issue-intelligence` directory to install the `pi` coding agent and other runtime dependencies. |
| 7 | **Run** | Runs `ISSUE-INTELLIGENCE-AGENT.ts` ‚Äî the core orchestrator. This step: resolves or creates a conversation session for the issue, builds a prompt from the event context, executes the `pi` AI agent with the prompt and any prior session context, extracts the final assistant reply, persists session state to git, commits and pushes all changes (with retry-on-conflict), posts the agent's reply as an issue comment, and removes the üëÄ reaction in a `finally` block. |

**Concurrency model:** Uses `concurrency.group: issue-intelligence-${{ github.event.issue.number }}` with `cancel-in-progress: false`. This serializes workflow runs for the same issue number (preventing session-state corruption from parallel writes) while allowing runs for different issues to proceed concurrently. Cross-issue push contention is handled by an exponential back-off retry loop in the agent script.

**Condition filter:** The workflow skips `issue_comment` events from `github-actions[bot]` to prevent the agent from triggering itself in an infinite feedback loop when it posts its own reply comments.

**Net effect:** The repository becomes a self-contained AI assistant platform. Every issue is a persistent chat thread with full memory across sessions, all state versioned in git, and zero external infrastructure beyond GitHub Actions and an LLM API key.

---

### 2. `ISSUE-INTELLIGENCE-INSTALLER.yml` ‚Äî The Installer/Bootstrap Workflow

**Location:** `.issue-intelligence/ISSUE-INTELLIGENCE-INSTALLER.yml` (source template; must be copied to `.github/workflows/` to activate)

**Trigger events:**
- `workflow_dispatch` ‚Äî manual trigger with configurable inputs (`overwrite` and `node-version`)
- `push` ‚Üí paths: `.github/workflows/ISSUE-INTELLIGENCE-INSTALLER.yml` ‚Äî re-runs when the installer workflow itself is updated
- `workflow_run` ‚Üí `ISSUE-INTELLIGENCE-WORKFLOW-AGENT` completed ‚Äî runs after the agent workflow completes (for ongoing maintenance/verification)

**Permissions granted:**
- `contents: write` ‚Äî allows committing workflow files, templates, and configuration
- `pull-requests: write` ‚Äî allows creating bootstrap pull requests

#### Effect

This workflow automates the installation and maintenance of Issue Intelligence into any repository. It converts the Bun-based source templates into Node.js/npm-compatible workflows and installs all necessary supporting files.

**Step-by-step effects:**

| Step | Name | Effect |
|------|------|--------|
| 1 | **Checkout** | Clones the repository with full history. |
| 2 | **Configure git** | Sets the bot identity (`github-actions[bot]`) for all commits. |
| 3 | **Resolve inputs** | Reads the `overwrite` and `node-version` inputs, defaulting to `false` and `20` respectively. |
| 4 | **Create bootstrap branch** | Creates a timestamped branch (`issue-intelligence/bootstrap-YYYYMMDD-HHMMSS`) to isolate changes. |
| 5 | **Install workflows (bun ‚Üí npm)** | Copies `.yml` files from `.issue-intelligence/install/` to `.github/workflows/` while performing automated Bun-to-Node conversion: replaces `oven-sh/setup-bun` with `actions/setup-node`, converts `bun install` to `npm ci`, converts `bun run` to `npm run`, converts `bun <file>.ts` to `npx tsx <file>.ts`, and converts `bun <file>.js` to `node <file>.js`. Skips existing files unless `overwrite=true`. |
| 6 | **Merge .gitignore** | Collects `.gitignore` rules from `.issue-intelligence/.gitignore` fragments and merges them into the root `.gitignore` within a managed block delimited by markers. This is idempotent ‚Äî re-runs replace the previous managed block. |
| 7 | **Copy issue templates** | Copies `ISSUE-INTELLIGENCE-TEMPLATE-*` files from the install directory to `.github/ISSUE_TEMPLATE/`, making them available as GitHub issue templates (e.g., the ü•ö Hatch template for personality creation). |
| 8 | **Copy optional config files** | Copies any `.editorconfig`, `.nvmrc`, `.npmrc`, `.eslintrc*`, `.prettierrc*` files and executable scripts from `.issue-intelligence/scripts/` if they exist. |
| 9 | **Mark installation complete** | Renames `ISSUE-INTELLIGENCE-NOT-INSTALLED.md` to `ISSUE-INTELLIGENCE-INSTALLED.md` as a status flag. |
| 10 | **Check for changes** | Stages all changes and checks if there is anything to commit. |
| 11 | **Commit and push** | Commits changes to the bootstrap branch and pushes. |
| 12 | **Open pull request** | Creates a PR from the bootstrap branch to the default branch with a descriptive body, allowing human review before the installation takes effect. |

**Safety guard:** The condition `if: github.actor != 'github-actions[bot]'` prevents the bot from re-triggering itself.

**Net effect:** A single workflow dispatch (or automatic trigger) converts a raw repository into a fully configured Issue Intelligence environment ‚Äî complete with workflows, templates, gitignore rules, and configuration ‚Äî delivered as a reviewable pull request rather than direct commits to the default branch.

---

## Architectural Design Principles

### Fail-Closed Security
The system defaults to **off**. A sentinel file (`ISSUE-INTELLIGENCE-ENABLED.md`) must exist for the agent to run. Deleting this file instantly disables all automation without removing any code or configuration. This prevents accidental automation on forks or freshly cloned repositories.

### Authorization Boundary
The agent workflow verifies repository-level permissions before processing any event. Only users with `write`, `maintain`, or `admin` access can trigger agent execution, preventing unauthorized consumption of LLM API resources on public repositories.

### Feedback Loop Prevention
The condition `github.event.comment.user.login != 'github-actions[bot]'` prevents the agent from reacting to its own comments, which would create an infinite loop of the agent talking to itself.

### Session Persistence via Git
All conversation state is stored as files in the repository (`state/issues/` and `state/sessions/`), committed after each interaction. This provides full auditability, version control over AI interactions, and the ability to roll back any agent action. No external database is needed.

### Concurrency Without Corruption
Per-issue concurrency groups ensure sequential processing within a single issue thread (preventing session file corruption), while cross-issue parallelism is maintained. Push conflicts between concurrent issue processing are resolved through exponential back-off with jitter.

### Progressive Feedback
The üëÄ reaction is added before dependency installation (the slowest step) so users receive immediate visual confirmation that their request is being processed. The reaction is removed in a `finally` block, guaranteeing cleanup regardless of success or failure.

### Installation via Pull Request
The installer workflow creates a branch and opens a PR rather than pushing directly to the default branch. This gives repository maintainers the opportunity to review all installed files before they take effect, following the principle of least surprise.

### Bun-to-Node Portability
The installer performs automated Bun-to-Node conversion, allowing the source templates to use Bun (for development speed) while deployed workflows use the more widely available Node.js runtime. This decouples the development toolchain from the deployment environment.

---

## Summary of Effects

| Workflow | Primary Effect | Secondary Effects |
|----------|---------------|-------------------|
| **Agent** | Converts GitHub issues into AI conversation threads with persistent memory | Authorization enforcement, visual activity indicators, session management, git-based state persistence, push conflict resolution, infinite-loop prevention |
| **Installer** | Bootstraps the Issue Intelligence system into any repository via a reviewable PR | Bun-to-Node conversion, gitignore management, issue template installation, installation status tracking, idempotent re-runs |

Together, these workflows create a **self-contained, zero-infrastructure AI assistant** that lives entirely within a GitHub repository. The design prioritizes safety (fail-closed, authorization, PR-based installation), reliability (retry logic, concurrency controls, guaranteed cleanup), and transparency (git-versioned state, reviewable changes, visible activity indicators).
